<h1 id='title'><%= @location.primary_site_name %></h1>
<br/>
<div id="location_wrapper">

  <div id="location_first_column">
    <div id="location_first_column_first_row">
      <div id="location_metadata">
        <% if @location.itinerary_order %>
          <p>Itinerary Order: <%= @location.itinerary_order %></p>
        <% end %>
        <% if @location.latitude %>
          <p>Latitude: <%= @location.latitude %></p>
        <% end %>
        <% if @location.longitude %>
          <p>Latitude: <%= @location.longitude %></p>
        <% end %>
        <% if @location.wikipedia_link %>
          <p><%= link_to 'Wikipedia', @location.wikipedia_link, target: :_blank %></p>
        <% end %>
        <% if @location.fortalezas_link %>
          <p><%= link_to 'Fortalezas.org', @location.fortalezas_link, target: :_blank %></p>
        <% end %>
        <% if @location.castillosnet_link %>
          <p ><%= link_to 'Castillos.net', @location.castillosnet_link, target: :_blank %></p>
        <% end %>
        <% if @location.at_collaborator_id %>
        <p>Collaborator: <div id="collaborator">
          <%= Collaborator.find_by(at_collaborator_id: @location.at_collaborator_id).name %></div>
        </p>
        <% end %>
      </div>
      <div id="location_plan">
        <% if @location.images.detect{|i| i.image_category == "plan"} %>
        <img src="<%= @location.images.detect{|i| i.image_category == "plan"}.url %>"></img>
        <% else %>
        <img src="<%= image_path 'plan_unavailable.png' %>"></img>
        <% end %>
      </div>
    </div>
    <div id="location_image_gallery_wrapper">
      <div id="location_image_gallery">
        <% if @location.a360_3D_model_embed %>
          <div class="location_image_card" id="3d_model">
            <div class="location_image_card_thumbnail">
              <img src="<%= asset_path '3d_model.png' %>" width="200px" height="auto"></img>
            </div>
          </div>
        <% end %>
        <% @location.images.select{|i| i.image_category != "plan"}.sort_by{|i| i.image_category}.each_with_index do |image, index| %>
          <div class="location_image_card" id="image_<%= index %>">
            <div class="location_image_card_thumbnail">
              <img src="<%= image.large_thumbnail_url %>" width="200px" height="auto"></img>
            </div>
            <div class="location_image_card_metadata">
              <% if image.view_direction %>
                <p>View: <%= image.view_direction %></p>
                <% if image.source == "1642_watercolor" %>
                  <p>1642 Watercolor</p>
                <% end %>
                <% if image.source == "Codex A" %>
                  <p>Codex A</p>
                <% end %>
              <% end %>
              <% if image.image_category == "satellite image" %>
                <p>Satellite Image</p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div> <!-- image gallery -->
    </div>
  </div> <!--location first column -->

  <div id="location_second_column">

    <% if @location.a360_3D_model_embed %>
      <div id="3d_model_iframe" class="openseadragon" style="display: none;">
        <%= @location.a360_3D_model_embed .html_safe %>
      </div>
    <% end %>

    <div id="openseadragon_plan" class="openseadragon" style="display: none;"></div>

    <% @location.images.select{|i| i.image_category != "plan"}.sort_by{|i| i.image_category}.each_with_index do |image, index| %>
      <div id="openseadragon_image_<%= index %>" class="openseadragon" style="display: none;"></div>
    <% end %>

    <br/>

    <div id="current_image_metadata"></div>

  </div><!--location second column -->
</div> <!--location_wrapper -->

<br/>
<br/>
<br/>
<br/>

<script type="text/javascript">

  var model = document.getElementById('3d_model');
  var plan_drawing = document.getElementById('location_plan');
  var image_cards = document.querySelectorAll(".location_image_card");
  var viewer_metadata = document.getElementById('current_image_metadata');
  if (model) {
    load_model();
  }
  else {
    var initial_image = document.getElementById('image_0');
    var initial_viewer = document.getElementById('openseadragon_image_0');
    initial_viewer.style.display = "";
    initial_image.style.border = "solid 2px red";
  }

  function add_listeners(){
    plan_drawing.addEventListener('click', load_plan);
    image_cards.forEach(function(card) {
      if (card.id != '3d_model') {
        card.addEventListener('click',load_image);
      }
    });
      if (model) {
        model.addEventListener('click',load_model);
      };
  }

  function hide_all(){
    [].forEach.call(document.querySelectorAll('.openseadragon'), function (e) {
      e.style.display = 'none';
    });
    image_cards.forEach(function(card){
      card.style.border = "solid 1px dimgray";
    });
    document.getElementById('location_plan').style.border = "solid 1px dimgray";
    viewer_metadata.innerHTML = '';
  }

  function load_image(){
    hide_all();
    openseadragon_image = document.getElementById('openseadragon_'+this.id);
    openseadragon_image.style.display = "";
    this.style.border = "solid 2px red";
    card_metadata = this.querySelector('.location_image_card_metadata');
    this.querySelectorAll('p').forEach(function(p) {
      x = p.cloneNode(true);
      viewer_metadata.appendChild(x);
  });
  }

  function load_model(){
    hide_all();
    let model_viewer = document.getElementById('3d_model_iframe');
    let model_viewer_iframe = model_viewer.getElementsByTagName("iframe")[0];
    model_viewer_iframe.style.width = "100%";
    model_viewer_iframe.style.height = "100%";
    model_viewer.style.display = "";
    model.style.border = "solid 2px red";
    collaborator = document.getElementById('collaborator').innerHTML;
    model_metadata = document.createTextNode("Modeled by: " + collaborator);
    model_p = document.createElement('p');
    model_p.appendChild(model_metadata);
    viewer_metadata.appendChild(model_p);
  }

  function load_plan(){
    hide_all();
    let openseadragon_plan = document.getElementById('openseadragon_plan');
    openseadragon_plan.style.display = "";
    plan_drawing.style.border = "solid 2px red";
    location_name = document.getElementById('title').innerHTML
    plan_metadata = document.createTextNode(location_name + " Plan");
    plan_p = document.createElement('p');
    plan_p.appendChild(plan_metadata);
    viewer_metadata.appendChild(plan_p);
  }

  var viewer = OpenSeadragon({
    id: "openseadragon_plan",
    tileSources: {
      type: 'image',
      <% if @location.images.detect{|i| i.image_category == "plan"} %>
      url: '<%=  @location.images.detect{|i| i.image_category == "plan"}.url %>'
      <% else %>
      url: '<%= image_path 'plan_unavailable.png' %>'
      <% end %>
    }
  });

  <% @location.images.select{|i| i.image_category != "plan"}.sort_by{|i| i.image_category}.each_with_index do |image, index| %>

    var viewer = OpenSeadragon({
      id: "openseadragon_image_<%= index %>",
      tileSources: {
        type: 'image',
        url: '<%= image.url %>'
      }
    });

  <% end %>

  add_listeners();
  
</script>
